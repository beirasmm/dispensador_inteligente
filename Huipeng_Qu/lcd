#include <WiFi.h>
#include <PubSubClient.h>
#include <LiquidCrystal.h>

// ================= Configuración de pines de hardware =================
// 1. Conexión de Pines LCD (Sin usar GPIO 6-11)
// Conexión Detallada del ESP32 al LCD:
const int rs = 19, en = 23, d4 = 18, d5 = 17, d6 = 16, d7 = 15;
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);

// 2. Pines del Sensor de Temperatura LM35
// LM35 VCC -> 3.3V (o 5V)
// LM35 GND -> GND
// LM35 OUT -> GPIO 34 (Pin ADC, Conversor Analógico-Digital)
const int lm35Pin = 34; 

const char* ssid = "xm";
const char* password = "cyj041108";

const char* mqtt_server = "test.mosquitto.org";
const int mqtt_port = 1883;
// Tema para el Envío de Datos (Publicación)
const char* mqtt_topic_pub = "devices/NAPIoT-P2-Temp"; 
// Tema para la Recepción de Comandos (Suscripción/Control de LED)
const char* mqtt_topic_sub = "devices/NAPIoT-P2-Rec";

WiFiClient espClient;
PubSubClient client(espClient);

// Variables del Temporizador (Para Envío con Retardo No Bloqueante)
unsigned long lastMsg = 0;
const long interval = 2000; // Enviar datos cada 2 segundos.

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Conectando a ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.println("WiFi conectada!");
  Serial.println("IP: ");
  Serial.println(WiFi.localIP());
}

void callback(char* topic, byte* payload, unsigned int length) {
  // Aquí se mantiene la lógica original de recepción. 
  // Si se requiere control inverso (actuadores), se puede implementar aquí.
  Serial.print("Mensaje Recibido [");
  Serial.print(topic);
  Serial.print("] ");
  for (int i = 0; i < length; i++) {
    Serial.print((char)payload[i]);
  }
  Serial.println();
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Intentando conexión MQTT...");
    // El ID de cliente (Client ID) debe ser único. Se recomienda añadir un sufijo aleatorio.
    String clientId = "ESP32Client-";
    clientId += String(random(0xffff), HEX);
    
    if (client.connect(clientId.c_str())) {
      Serial.println("conectado");
      client.subscribe(mqtt_topic_sub); // Volver a suscribirse al tema de recepción
    } else {
      Serial.print("falló, rc=");
      Serial.print(client.state());
      Serial.println(" reintentando en 5 segundos");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(115200); // El ESP32 suele usar 115200 baudios
  
  // Inicializar LCD
  // Si usas una pantalla 0802, cambia a: lcd.begin(8, 2);
  // Si es la pantalla 1602 de la imagen, mantén: 16, 2
  lcd.begin(16, 2); 
  lcd.setCursor(0, 0);
  lcd.print("Iniciando sist...");

  // Configurar resolución del ADC (El ESP32 es de 12 bits por defecto)
  analogReadResolution(12); 

  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);
  
  lcd.clear();
  lcd.print("WiFi OK");
  delay(1000);
  lcd.clear();
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // Uso de millis() para envío no bloqueante, evitando que delay() afecte la estabilidad MQTT
  unsigned long now = millis();
  if (now - lastMsg > interval) {
    lastMsg = now;

    // --- 1. Lectura de temperatura ---
    int adcVal = analogRead(lm35Pin);
    
    // --- 2. Cálculo de temperatura (Fórmula corregida para ESP32) ---
    // El ADC del ESP32 tiene 12 bits (0-4095)
    // Asumiendo que el voltaje de referencia es 3.3V (3300mV)
    // Salida del LM35: 10mV = 1 Grado Celsius
    // Voltaje(mV) = (adcVal / 4095.0) * 3300
    // Temperatura(C) = Voltaje / 10
    float voltage = (adcVal / 4095.0) * 3300.0;
    float temperature = voltage / 10.0;

    // *Nota: La linealidad del ADC del ESP32 no es tan buena como la del Arduino Uno.
    // Si hay mucha desviación, podría requerir calibración o el uso de la función map().
    
    // --- 3. Impresión por Puerto Serie ---
    Serial.print("Temp: ");
    Serial.print(temperature);
    Serial.println(" C");

    // --- 4. Visualización en LCD ---
    lcd.setCursor(0, 0); // Primera fila
    lcd.print("Temp: ");
    lcd.print(temperature, 1); // Mostrar con 1 decimal
    lcd.print("C    ");       // Espacios extra para limpiar caracteres antiguos

    lcd.setCursor(0, 1); // Segunda fila
    lcd.print("Subiendo a MQTT");

    // --- 5. Publicación en MQTT ---
    // Convertir el valor flotante a una cadena de caracteres (string)
    char tempString[8];
    dtostrf(temperature, 1, 2, tempString); // Formato: ancho mínimo 1, 2 decimales
    
    client.publish(mqtt_topic_pub, tempString);
    Serial.print("Publicado en ");
    Serial.print(mqtt_topic_pub);
    Serial.print(": ");
    Serial.println(tempString);
  }
}
